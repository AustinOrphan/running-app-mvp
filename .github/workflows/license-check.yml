name: ğŸ“„ License Compliance Check

on:
  push:
    branches: [main, develop]
    paths:
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches: [main, develop]
    paths:
      - 'package.json'
      - 'package-lock.json'
  schedule:
    # Run monthly on the 1st at 9 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

jobs:
  license-check:
    name: ğŸ“„ Check License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ“¦ Install license-checker
        run: npm install -g license-checker

      - name: ğŸ“„ Check allowed licenses
        run: |
          echo "ğŸ” Checking license compliance..."
          # Add AGPL-3.0 for marchingsquares, EPL-1.0 for jsts packages, and handle unknown-license-reference
          license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;Unlicense;0BSD;BlueOak-1.0.0;CC0-1.0;Python-2.0;Zlib;MPL-2.0;AGPL-3.0;EPL-1.0' --excludePrivatePackages --exclude 'lib/*' --excludePackages 'victory-vendor@37.3.6'

      - name: ğŸ“Š Generate detailed license report
        run: |
          echo "ğŸ“Š Generating detailed license report..."
          license-checker --json --out licenses.json
          license-checker --csv --out licenses.csv

      - name: ğŸ“„ Check for problematic licenses
        run: |
          echo "ğŸš¨ Checking for problematic licenses..."

          # Check for GPL licenses (copyleft)
          if license-checker --json | grep -i "gpl\|lgpl\|agpl" > /dev/null; then
            echo "âš ï¸ WARNING: GPL/LGPL/AGPL licenses detected!"
            license-checker --json | grep -i "gpl\|lgpl\|agpl" || true
            echo "GPL_DETECTED=true" >> $GITHUB_ENV
          else
            echo "âœ… No GPL licenses detected"
            echo "GPL_DETECTED=false" >> $GITHUB_ENV
          fi

          # Check for other restrictive licenses
          if license-checker --json | grep -i "cc-by-nc\|cc-by-sa\|commercial\|proprietary" > /dev/null; then
            echo "âš ï¸ WARNING: Restrictive licenses detected!"
            license-checker --json | grep -i "cc-by-nc\|cc-by-sa\|commercial\|proprietary" || true
            echo "RESTRICTIVE_DETECTED=true" >> $GITHUB_ENV
          else
            echo "âœ… No restrictive licenses detected"
            echo "RESTRICTIVE_DETECTED=false" >> $GITHUB_ENV
          fi

      - name: ğŸ“„ Generate license summary
        run: |
          echo "ğŸ“‹ License Summary" > license-summary.md
          echo "==================" >> license-summary.md
          echo "" >> license-summary.md
          echo "## ğŸ“Š License Distribution" >> license-summary.md
          echo "" >> license-summary.md
          license-checker --summary >> license-summary.md
          echo "" >> license-summary.md
          echo "## ğŸ” License Details" >> license-summary.md
          echo "" >> license-summary.md
          license-checker --markdown >> license-summary.md

      - name: ğŸ“Š Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            licenses.json
            licenses.csv
            license-summary.md
          retention-days: 30

      - name: ğŸ“ Comment on PR with license changes
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the license summary
            let summary = '';
            try {
              summary = fs.readFileSync('license-summary.md', 'utf8');
            } catch (error) {
              summary = 'Unable to read license summary';
            }

            const warningMessage = process.env.GPL_DETECTED === 'true' || process.env.RESTRICTIVE_DETECTED === 'true' 
              ? 'âš ï¸ **WARNING: Potentially problematic licenses detected!**\n\n' 
              : '';

            const comment = `## ğŸ“„ License Compliance Check Results

            ${warningMessage}

            ### ğŸ“Š Summary
            - **GPL licenses detected:** ${process.env.GPL_DETECTED === 'true' ? 'âš ï¸ Yes' : 'âœ… No'}
            - **Restrictive licenses detected:** ${process.env.RESTRICTIVE_DETECTED === 'true' ? 'âš ï¸ Yes' : 'âœ… No'}

            ### ğŸ“‹ Allowed Licenses
            - MIT
            - Apache-2.0
            - BSD-2-Clause / BSD-3-Clause
            - ISC
            - Unlicense
            - 0BSD
            - BlueOak-1.0.0
            - CC0-1.0
            - Python-2.0
            - Zlib

            <details>
            <summary>ğŸ“Š Full License Report</summary>

            \`\`\`
            ${summary}
            \`\`\`

            </details>

            ---
            *License compliance check completed by [License Check Workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: âŒ Fail on problematic licenses
        if: env.GPL_DETECTED == 'true' || env.RESTRICTIVE_DETECTED == 'true'
        run: |
          echo "âŒ License compliance check failed!"
          echo "Problematic licenses detected that may require legal review."
          echo "Please review the license report and consider alternatives."
          exit 1

  # Summary job
  license-summary:
    name: ğŸ“‹ License Summary
    runs-on: ubuntu-latest
    needs: [license-check]
    if: always()

    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "## ğŸ“„ License Compliance Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.license-check.result == 'success' && 'âœ… Compliant' || 'âŒ Issues detected' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Compliance Check:" >> $GITHUB_STEP_SUMMARY
          echo "- Scanned all npm dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- Verified against allowed license list" >> $GITHUB_STEP_SUMMARY
          echo "- Checked for GPL/LGPL/AGPL licenses" >> $GITHUB_STEP_SUMMARY
          echo "- Checked for restrictive licenses" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Purpose:" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure legal compliance for distribution" >> $GITHUB_STEP_SUMMARY
          echo "- Avoid copyleft license conflicts" >> $GITHUB_STEP_SUMMARY
          echo "- Maintain commercial viability" >> $GITHUB_STEP_SUMMARY
          echo "- Automated license monitoring" >> $GITHUB_STEP_SUMMARY
