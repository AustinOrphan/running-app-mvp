name: 🛡️ Advanced Security Scanning

on:
  # Run on all PRs and pushes to main
  push:
    branches: [main]
  pull_request:
    branches: [main]
    
  # Weekly comprehensive security scan
  schedule:
    - cron: '0 02:00 * * 1'  # 2 AM ET every Monday
    
  # Manual trigger for immediate security assessment
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - 'comprehensive'
          - 'quick'
          - 'dependencies-only'
          - 'sast-only'

# Limit resource usage
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # SAST (Static Application Security Testing)
  sast-scan:
    name: 🔍 Static Code Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'dependencies-only'
    
    permissions:
      contents: read
      security-events: write
      
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 🔧 Install dependencies
        run: npm ci
        
      # ESLint security analysis
      - name: 🔍 ESLint Security Scan
        run: |
          # Install security-focused ESLint plugins
          npm install --no-save eslint-plugin-security eslint-plugin-no-secrets
          
          # Create temporary ESLint config for security scanning
          cat > .eslintrc.security.js << 'EOF'
          module.exports = {
            extends: ['./.eslintrc.js'],
            plugins: ['security', 'no-secrets'],
            rules: {
              // Security rules
              'security/detect-unsafe-regex': 'error',
              'security/detect-buffer-noassert': 'error',
              'security/detect-child-process': 'warn',
              'security/detect-disable-mustache-escape': 'error',
              'security/detect-eval-with-expression': 'error',
              'security/detect-no-csrf-before-method-override': 'error',
              'security/detect-non-literal-fs-filename': 'warn',
              'security/detect-non-literal-regexp': 'warn',
              'security/detect-non-literal-require': 'warn',
              'security/detect-object-injection': 'warn',
              'security/detect-possible-timing-attacks': 'warn',
              'security/detect-pseudoRandomBytes': 'error',
              
              // Secrets detection
              'no-secrets/no-secrets': ['error', {
                'tolerance': 4.2,
                'additionalRegexes': {
                  'Basic Auth': 'Authorization: Basic [A-Za-z0-9+/=]+',
                  'JWT Token': 'ey[A-Za-z0-9-_=]+\\.[A-Za-z0-9-_=]+\\.?[A-Za-z0-9-_.+/=]*'
                }
              }]
            }
          };
          EOF
          
          # Run security-focused linting
          npx eslint --config .eslintrc.security.js --ext .js,.ts,.tsx src/ server/ --format json --output-file eslint-security-results.json || true
          
          # Generate security report
          if [ -f eslint-security-results.json ]; then
            issues_count=$(jq 'map(.messages | length) | add // 0' eslint-security-results.json)
            echo "ESLINT_SECURITY_ISSUES=$issues_count" >> $GITHUB_ENV
          else
            echo "ESLINT_SECURITY_ISSUES=0" >> $GITHUB_ENV
          fi
          
      # Semgrep security analysis
      - name: 🔍 Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/typescript
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true
        
      # Upload security scan results
      - name: 📤 Upload security results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-results
          path: |
            eslint-security-results.json
            .semgrep/
          retention-days: 30

  # Dependency vulnerability analysis
  dependency-security:
    name: 📦 Dependency Security Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'sast-only'
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 🔧 Install dependencies
        run: npm ci
        
      # Comprehensive npm audit
      - name: 🔍 NPM Security Audit
        id: npm-audit
        run: |
          # Run audit with detailed output
          npm audit --json > npm-audit-results.json 2>/dev/null || true
          
          # Extract vulnerability counts
          if [ -f npm-audit-results.json ]; then
            total=$(jq -r '.metadata.vulnerabilities.total // 0' npm-audit-results.json)
            critical=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)
            high=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
            moderate=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-audit-results.json)
            low=$(jq -r '.metadata.vulnerabilities.low // 0' npm-audit-results.json)
            
            echo "total_vulns=$total" >> $GITHUB_OUTPUT
            echo "critical_vulns=$critical" >> $GITHUB_OUTPUT
            echo "high_vulns=$high" >> $GITHUB_OUTPUT
            echo "moderate_vulns=$moderate" >> $GITHUB_OUTPUT
            echo "low_vulns=$low" >> $GITHUB_OUTPUT
          fi
          
      # Snyk vulnerability scanning
      - name: 🔍 Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --json-file-output=snyk-results.json
        continue-on-error: true
        
      # OWASP dependency check
      - name: 🔍 OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'running-app-mvp'
          path: '.'
          format: 'JSON'
          out: 'dependency-check-reports'
          args: >
            --enableRetired
            --enableExperimental
            --nodeAuditSkipDevDependencies
            --nodePackageSkipDevDependencies
        continue-on-error: true
        
      # Generate vulnerability summary
      - name: 📊 Generate Vulnerability Summary
        if: always()
        run: |
          echo "## 📦 Dependency Security Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # NPM Audit Results
          echo "### NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Total vulnerabilities**: ${{ steps.npm-audit.outputs.total_vulns }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical**: ${{ steps.npm-audit.outputs.critical_vulns }}" >> $GITHUB_STEP_SUMMARY
          echo "- **High**: ${{ steps.npm-audit.outputs.high_vulns }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Moderate**: ${{ steps.npm-audit.outputs.moderate_vulns }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Low**: ${{ steps.npm-audit.outputs.low_vulns }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if any critical/high vulnerabilities
          critical="${{ steps.npm-audit.outputs.critical_vulns }}"
          high="${{ steps.npm-audit.outputs.high_vulns }}"
          
          if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
            echo "⚠️ **Action Required**: Critical or high severity vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended actions**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Run \`npm audit fix\` to automatically fix issues" >> $GITHUB_STEP_SUMMARY
            echo "2. Review the vulnerability details in the full report" >> $GITHUB_STEP_SUMMARY
            echo "3. Update dependencies manually if auto-fix doesn't work" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **No critical or high severity vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          
      # Upload dependency scan results
      - name: 📤 Upload dependency scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-results
          path: |
            npm-audit-results.json
            snyk-results.json
            dependency-check-reports/
          retention-days: 30
          
      # Fail if critical vulnerabilities found
      - name: ❌ Fail on critical vulnerabilities
        if: steps.npm-audit.outputs.critical_vulns != '0'
        run: |
          echo "❌ Critical vulnerabilities found! Build will fail."
          echo "Critical vulnerabilities: ${{ steps.npm-audit.outputs.critical_vulns }}"
          exit 1

  # Container security scanning (if using Docker)
  container-security:
    name: 🐳 Container Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'comprehensive'
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        
      # Check if Dockerfile exists
      - name: 🔍 Check for Docker files
        id: docker-check
        run: |
          if [ -f "Dockerfile" ] || [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
            echo "has_docker=true" >> $GITHUB_OUTPUT
          else
            echo "has_docker=false" >> $GITHUB_OUTPUT
          fi
          
      # Build Docker image if Dockerfile exists
      - name: 🏗️ Build Docker image
        if: steps.docker-check.outputs.has_docker == 'true'
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t running-app:security-scan .
          fi
          
      # Trivy container vulnerability scan
      - name: 🔍 Trivy Container Scan
        if: steps.docker-check.outputs.has_docker == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'running-app:security-scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      # Upload Trivy results to GitHub Security tab
      - name: 📤 Upload Trivy results
        if: steps.docker-check.outputs.has_docker == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # Security configuration review
  security-config-review:
    name: ⚙️ Security Configuration Review
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        
      # Check for security-related configuration files
      - name: 🔍 Security Configuration Analysis
        run: |
          echo "## ⚙️ Security Configuration Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for important security files
          config_files=(
            ".github/dependabot.yml:Automated dependency updates"
            ".github/workflows/codeql-analysis.yml:CodeQL security scanning"
            ".github/workflows/security-scanning.yml:Advanced security scanning"
            ".eslintrc.js:Code quality and security linting"
            "package.json:Dependency management"
            ".gitignore:Prevents committing sensitive files"
            ".env.example:Environment variable template"
          )
          
          echo "### Security Configuration Files" >> $GITHUB_STEP_SUMMARY
          
          for config in "${config_files[@]}"; do
            file=$(echo "$config" | cut -d: -f1)
            desc=$(echo "$config" | cut -d: -f2-)
            
            if [ -f "$file" ]; then
              echo "✅ **$file**: $desc" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **$file**: Missing - $desc" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for potential security issues in package.json
          if [ -f "package.json" ]; then
            echo "### Package.json Security Review" >> $GITHUB_STEP_SUMMARY
            
            # Check for known vulnerable scripts
            if jq -e '.scripts | to_entries[] | select(.value | contains("sudo"))' package.json > /dev/null 2>&1; then
              echo "⚠️ **Warning**: Scripts contain 'sudo' commands" >> $GITHUB_STEP_SUMMARY
            fi
            
            if jq -e '.scripts | to_entries[] | select(.value | contains("rm -rf"))' package.json > /dev/null 2>&1; then
              echo "⚠️ **Warning**: Scripts contain potentially dangerous 'rm -rf' commands" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check for postinstall scripts
            if jq -e '.scripts.postinstall' package.json > /dev/null 2>&1; then
              echo "⚠️ **Notice**: Package has postinstall script - review for security" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "✅ **Package.json security review completed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for environment variable security
          echo "### Environment Security" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".env" ]; then
            echo "⚠️ **Warning**: .env file found in repository" >> $GITHUB_STEP_SUMMARY
            echo "Ensure it's included in .gitignore and doesn't contain production secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **No .env file in repository**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f ".env.example" ]; then
            echo "✅ **Environment template provided**" >> $GITHUB_STEP_SUMMARY
          else
            echo "💡 **Suggestion**: Consider adding .env.example as a template" >> $GITHUB_STEP_SUMMARY
          fi

  # Final security summary
  security-summary:
    name: 📋 Security Summary
    runs-on: ubuntu-latest
    needs: [sast-scan, dependency-security, container-security, security-config-review]
    if: always()
    
    steps:
      - name: 📊 Generate comprehensive security summary
        run: |
          echo "# 🛡️ Comprehensive Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Type**: ${{ github.event.inputs.scan_type || 'comprehensive' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job status summary
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.sast-scan.result }}" = "success" ]; then
            echo "✅ **Static Analysis (SAST)**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.sast-scan.result }}" = "failure" ]; then
            echo "❌ **Static Analysis (SAST)**: Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.sast-scan.result }}" = "skipped" ]; then
            echo "⏭️ **Static Analysis (SAST)**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.dependency-security.result }}" = "success" ]; then
            echo "✅ **Dependency Security**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.dependency-security.result }}" = "failure" ]; then
            echo "❌ **Dependency Security**: Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.dependency-security.result }}" = "skipped" ]; then
            echo "⏭️ **Dependency Security**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.container-security.result }}" = "success" ]; then
            echo "✅ **Container Security**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.container-security.result }}" = "failure" ]; then
            echo "❌ **Container Security**: Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.container-security.result }}" = "skipped" ]; then
            echo "⏭️ **Container Security**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-config-review.result }}" = "success" ]; then
            echo "✅ **Configuration Review**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.security-config-review.result }}" = "failure" ]; then
            echo "❌ **Configuration Review**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          failed_jobs=""
          if [ "${{ needs.sast-scan.result }}" = "failure" ]; then failed_jobs="$failed_jobs SAST"; fi
          if [ "${{ needs.dependency-security.result }}" = "failure" ]; then failed_jobs="$failed_jobs Dependency"; fi
          if [ "${{ needs.container-security.result }}" = "failure" ]; then failed_jobs="$failed_jobs Container"; fi
          if [ "${{ needs.security-config-review.result }}" = "failure" ]; then failed_jobs="$failed_jobs Config"; fi
          
          if [ -n "$failed_jobs" ]; then
            echo "## ⚠️ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following security scans failed:$failed_jobs" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the detailed results and address any security issues found." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ All Security Scans Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No critical security issues detected across all scan types." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For detailed results, review individual job outputs and the Security tab." >> $GITHUB_STEP_SUMMARY